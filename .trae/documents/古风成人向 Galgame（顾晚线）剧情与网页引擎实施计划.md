## 目标与范围
- 单人物线路（顾晚线）先行：不少于50个大场景、≥5000条对白与不同选项，总时长≥2小时。
- 技术栈：`html+js+css`，在 `webroot/` 内实现完整网页端galgame功能。
- 剧情文件：写入 `plot.md`，采用可解析的结构化片段（场景级数据块），由前端引擎加载。
- 成人向边界：所有角色均为成年人；亲密演出基于明确同意；R-18节点采用淡写与氛围，避免低俗与不当权力场景。

## 世界观与角色（精简）
- 背景：中晚朝江南府城，书院、茶肆、戏楼、花灯市、渡口、雨巷。
- 男主：`林清河`（成年，书院助教，冷静、细致）。
- 女主：`顾晚`（茶馆掌柜之女，温柔克制，家庭旧账纠葛）。
- 配角：茶馆伙计、账房先生、旧客、牙行、里正、书院同僚等，服务主线推进与人物立体化。

## 剧情结构（顾晚线）
- 五幕式结构：
  - 幕一（导入，场景1–10）：相识、茶路旧账引子、关系建立。
  - 幕二（发展，场景11–20）：核账与调查、信任试炼、小危机。
  - 幕三（转折，场景21–30）：真相线索收束、家庭抉择、外部压力。
  - 幕四（高潮，场景31–40）：对质与选择、关系确认、R-18节点（基于好感与同意）。
  - 幕五（尾声，场景41–50+）：余波收束、结局分化（HE/NE/BE），视线索完成度增加加演场景至55+。
- 关键选择：夜访茶仓/明日核账、公开旧账/内部解决、守护顾晚/直面是非；多处分支影响好感与结局矩阵。

## R-18触发规范
- 变量：`gu_wan_qin_mi_du`、`CONSENT_CONFIRMED`、`R18_THRESHOLD`。
- 条件：好感≥阈值、剧情链完成、明确同意选项；进入成人演出后提供事后关怀分支。
- 表现：以触觉、呼吸、衣物细节与空间氛围描述，强调彼此选择。

## `plot.md` 数据格式
- 文件结构：分章节与场景；每个场景使用代码块封装`json`对象，命名蛇形；示例：
```
```scene-json
{
    "scene_id": "gw_001_intro",
    "title": "雨巷相遇",
    "location": "茶馆外雨巷",
    "time_of_day": "傍晚",
    "preconditions": {"route_gu_wan_locked": 0},
    "dialogues": [
        {"speaker": "gu_wan", "line": "今雨微寒，先生且入内避一避。", "emotion": "gentle"},
        {"speaker": "lin_qing_he", "line": "多谢。茶香似有旧识。", "emotion": "calm"}
    ],
    "choices": [
        {"text": "入内与顾晚并肩核账", "set_flags": {"gu_wan_qin_mi_du": "+5"}, "next": "gw_002_tea_house"},
        {"text": "明日再来", "next": "gw_003_tomorrow"}
    ],
    "set_flags": {"route_gu_wan_locked": 0}
}
```
```
- 字段：`scene_id`、`title`、`summary`、`location`、`time_of_day`、`preconditions`、`dialogues[]`、`choices[]`、`set_flags`、`stats_delta`。
- 常量：`MAX_QIN_MI_DU = 100`、`R18_THRESHOLD = 70`。

## 前端引擎设计（`webroot/`）
- 文件：`index.html`（主容器与UI）、`styles.css`（主题与动画）、`engine.js`（场景流转）、`state.js`（状态机与变量）、`renderer.js`（对话渲染与选项UI）、`script_loader.js`（拉取并解析`plot.md`场景块）、`save_manager.js`（存档/读档 `localStorage`）、`audio_manager.js`（BGM/SE控制）、`router.js`（根据`scene_id`索引场景）。
- 命名与注释：全部蛇形命名；常量大写；注释采用中文`/** doxygen风格 */`；统一4空格缩进与UTF-8。

## 功能清单
- 基础：对话框、姓名牌、选择分支、立绘/背景占位、场景切换淡入淡出、打字机效果。
- 可选：自动播放、日志（backlog）、快进、快存/快读、音量与文本速度设置、R-18提示与遮罩、屏幕适配（PC/移动）。
- 存档：多槽存档、最近进度自动存档、结局成就记录与展示。

## 生成规模与时长保证
- 目标对白≥5000条：均匀分布于≥50大场景，含大量选项与分支文本；单场景对白均值≥100条。
- 时长≥2小时：基于阅读速度与分支探索设计，单线完整通关约120–150分钟。

## 实施步骤
1. 创建`webroot/`与前端骨架（空UI与解析模块），确保能加载并展示`plot.md`中一个场景。
2. 在`plot.md`建立顾晚线的场景索引与50+场景空壳（仅元数据与少量对白），打通全线流转与结局矩阵。
3. 扩写对白至≥5000条；补充多层选择与变量变化；插入R-18节点（含同意选项与事后关怀）。
4. 完成UI功能：日志、自动播放、快进、存档/读档、设置面板、R-18遮罩提示。
5. 自测与修正：分支覆盖率、死链检测、变量一致性、移动端适配。

## 验证与交付
- 通过浏览器本地预览验证引擎功能与剧情流畅度；提供一次性`plot.md`全文与前端文件。
- 提供运行指南与后续拓展路线（白霜线、江见线可复用框架）。

确认后，我将：
- 生成并写入`plot.md`的完整顾晚线（≥50场景、≥5000对白与选项）。
- 在`webroot/`创建并实现前端引擎与UI，以蛇形命名和中文doxygen注释完成所有JS/CSS。