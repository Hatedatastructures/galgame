## 目标
- 将前端剧情加载切换为调用后端接口，统一从服务端返回 `JSON` 场景与路由；静态资源继续走服务器静态路径。
- 在后端实现文件内容内存缓存，避免频繁磁盘 I/O（图片、脚本、CSS、JSON 都可缓存）。

## 后端改造（C++20，server.hpp/server.cpp）
### 新增接口
- `GET /api/health`：已存在，保留。
- `GET /api/route`：返回 `data/route_gu_wan.json` 内容（`application/json`）。
- `GET /api/scene/{scene_id}`：返回 `data/route_gu_wan_scenes/{scene_id}.json` 内容（`application/json`）。
  - `scene_id` 例如：`gw_001_intro`。
- 静态文件仍走现有逻辑（`webroot/**`）。

### 内存缓存设计
- 在 `server` 类中新增：
  - `std::unordered_map<std::string, std::string> asset_cache;` // key 用 `weakly_canonical` 的绝对路径
  - `std::mutex asset_cache_mtx;` // 简单互斥保护
- 缓存策略：
  - 读取文件时优先查缓存；未命中则读磁盘并写入缓存。
  - 可先实现“无上限缓存”（资源量可控），必要时再扩展 LRU。
- 改造点：
  - `make_static_response(...)`：改为从缓存读取；若不存在则读入并放入缓存。
  - 新增 `read_file_cached(const std::filesystem::path &full)` 供 `route/scene` 读取。

### 请求路由改造
- 在 `default_handle_request(...)` 中：
  - 解析 `target`，匹配：
    - `/api/route` → 返回缓存读取 `data/route_gu_wan.json`
    - `/api/scene/{id}` → 返回缓存读取 `data/route_gu_wan_scenes/{id}.json`
    - 其余 → 现有静态文件路径校验与返回（含 404/500）。
- 增加 `Access-Control-Allow-Origin: *` 以便前端在同域或不同端口都能访问。

### 其他考虑
- MIME 类型：复用现有 `extension_map`。
- 错误处理：读取失败返回 404；异常返回 500。
- 并发与安全：保持相对路径锚定在 `web_root`；API 路径锚定在 `data/` 子目录，拒绝 `..`。

## 前端改造（webroot/*.js & index.html）
### 剧情加载切换到后端
- 修改 `webroot/script_loader.js`：
  - 新增 `async function fetch_route_json_from_server()`：`GET /api/route`。
  - 新增 `async function fetch_scene_json_from_server(scene_id)`：`GET /api/scene/{scene_id}`。
  - 启动时优先调用服务端版本，失败时回退到本地 `file://`（保留健壮性）。
- 修改 `webroot/engine.js`：
  - 在 `start_first_scene()`/`go_to_scene()` 使用 `fetch_scene_json_from_server(scene_id)` 获取对话；保持 `apply_scene_visuals()` 的图片路径为 `assets/...`（仍由静态服务器提供）。

### 初始化与联调
- `index.html` 保持 DOMReady 初始化；不改脚本顺序。
- 不调整已完成的 UI/交互逻辑（主菜单、玻璃遮罩、日志）以避免引入额外风格偏差。

## 验证与测试
1. 启动后端（8080）：`server.exe` 输出初始化成功。
2. 前端通过 `http://localhost:8080/index.html` 打开：
   - “开始游戏”后调用 `/api/scene/gw_000_fallback_intro` 或路由中第一个场景；对话正常显示。
   - 切换场景时后端返回 JSON；图片路径直接走静态文件（且已内存缓存）。
3. 刷新页面反复测试，确认图片/JSON 均走内存缓存（可通过在后端添加日志打印命中/加载行为）。

## 变更文件清单
- `galgameserver/server.hpp`：新增缓存成员与辅助函数，扩展 `default_handle_request` 路由。
- `galgameserver/server.cpp`：不改启动逻辑，仅依赖 `server.hpp` 新增功能。
- `galgameserver/webroot/script_loader.js`：新增服务端获取函数与回退机制。
- `galgameserver/webroot/engine.js`：将场景获取调用切到服务端版本（保留回退）。

如果确认，即刻按上述方案实现、联调并自测，不做无意义修改。